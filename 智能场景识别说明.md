# 智能场景识别决策系统

## 🎯 设计理念

**核心思想**：根据**三个方向**（前、左、右）的传感器数据，智能识别当前场景，并采取最优决策。

---

## 📊 决策树

```
传感器读数 (F, L, R)
    │
    ├─ F<0.5 && L<0.5 && R<0.5 ──→ ⚠️  死胡同 ──→ BACKUP
    │
    ├─ L<0.5 && F>0.5 ──→ ➡️  左墙右通 ──→ ROTATE_RIGHT
    │
    ├─ R<0.5 && F>0.5 ──→ ⬅️  右墙左通 ──→ ROTATE_LEFT
    │
    ├─ L<0.8 && R<0.8 && F>0.5 ──→ 🚪 狭窄通道 ──→ FORWARD
    │
    ├─ F>0.6 ──→ 🛣️  前方开阔 ──→ FORWARD
    │
    └─ 其他 ──→ 🔄 需要转向 ──→ ROTATE (toward more open side)
```

---

## 🎬 场景详解

### 场景 1: ⚠️  死胡同

**特征**：
- 前方距离 < 0.5m
- 左侧距离 < 0.5m
- 右侧距离 < 0.5m

**示意图**：
```
     ████████████████
     █              █
     █    🤖        █
     █   ←──        █
     ████████████████
```

**决策**：`BACKING_UP` 后退

**理由**：三面都是墙，必须后退脱离

---

### 场景 2: ➡️  左墙右通

**特征**：
- 左侧距离 < 0.5m（墙壁）
- 前方距离 > 0.5m（可通行）
- 右侧距离 > 左侧（更开阔）

**示意图**：
```
     ████████████
     █
     █   🤖 ──→
     █   ↻
     ████████████
```

**决策**：`ROTATE_RIGHT` 右转

**理由**：左侧是墙，右侧更开阔，应该右转探索

---

### 场景 3: ⬅️  右墙左通

**特征**：
- 右侧距离 < 0.5m（墙壁）
- 前方距离 > 0.5m（可通行）
- 左侧距离 > 右侧（更开阔）

**示意图**：
```
            ████████████
                       █
         ←── 🤖        █
             ↺         █
            ████████████
```

**决策**：`ROTATE_LEFT` 左转

**理由**：右侧是墙，左侧更开阔，应该左转探索

---

### 场景 4: 🚪 狭窄通道（门口）

**特征**：
- 左侧距离 < 0.8m
- 右侧距离 < 0.8m
- 前方距离 > 0.5m

**这是最典型的门口特征！**

**示意图**：
```
     ████████      ████████
     █      █      █      █
     █      █ 🚪   █      █
     █      █ 0.6m█      █
     █      █      █      █
     █      █  🤖  █      █
     █      █  ↑   █      █
     ████████      ████████
      L=0.4m        R=0.5m
```

**决策**：`MOVING_FORWARD` 前进

**理由**：
- 两侧都近（< 0.8m）说明是狭窄通道
- 前方通（> 0.5m）说明可以通过
- 这正是门口的典型特征

**关键改进**：
- ✅ 之前要求 L>1.5 && R>1.5（太严格，漏检门口）
- ✅ 现在要求 L<0.8 && R<0.8（准确识别狭窄通道）

---

### 场景 5: 🛣️  前方开阔

**特征**：
- 前方距离 > 0.6m

**示意图**：
```

     🤖 ──────────→

```

**决策**：`MOVING_FORWARD` 前进

**理由**：前方开阔，安全前进

---

### 场景 6: 🔄 需要转向

**特征**：
- 不符合上述任何场景

**决策**：
- 如果 L > R：`ROTATE_LEFT`
- 如果 R > L：`ROTATE_RIGHT`

**理由**：转向更开阔的一侧继续探索

---

## 📈 实战案例

### 案例 1：通过标准门口

**环境**：房间门口（宽度 0.8m）

**传感器读数**：
```
F = 0.65m  (门后走廊)
L = 0.45m  (左侧门框)
R = 0.50m  (右侧门框)
```

**决策过程**：
1. 检查：L=0.45 < 0.8 ✓
2. 检查：R=0.50 < 0.8 ✓
3. 检查：F=0.65 > 0.5 ✓
4. **识别**：🚪 狭窄通道
5. **动作**：MOVING_FORWARD

**结果**：✅ 成功通过门口

**日志输出**：
```
🤖 LLM: MOVING_FORWARD  | 🚪 狭窄通道    | F=0.65 L=0.45 R=0.50
```

---

### 案例 2：T 型路口左转

**环境**：T 型路口，前方是墙，左侧是开阔走廊

**传感器读数**：
```
F = 0.45m  (前方墙壁)
L = 2.50m  (左侧走廊)
R = 0.40m  (右侧墙壁)
```

**决策过程**：
1. 检查：F=0.45 < 0.5 ✗（不满足狭窄通道）
2. 检查：R=0.40 < 0.5 ✓
3. 检查：L=2.50 > R ✓（左侧更开阔）
4. **识别**：⬅️  右墙左通
5. **动作**：ROTATE_LEFT

**结果**：✅ 正确左转进入开阔走廊

**日志输出**：
```
🤖 LLM: ROTATING_LEFT   | ⬅️  右墙左通  | F=0.45 L=2.50 R=0.40
```

---

### 案例 3：死胡同后退

**环境**：走廊尽头，三面墙壁

**传感器读数**：
```
F = 0.35m  (前墙)
L = 0.40m  (左墙)
R = 0.42m  (右墙)
```

**决策过程**：
1. 检查：F=0.35 < 0.5 ✓
2. 检查：L=0.40 < 0.5 ✓
3. 检查：R=0.42 < 0.5 ✓
4. **识别**：⚠️  死胡同
5. **动作**：BACKING_UP

**结果**：✅ 后退脱离死胡同

**日志输出**：
```
🤖 LLM: BACKING_UP      | ⚠️  死胡同    | F=0.35 L=0.40 R=0.42
```

---

### 案例 4：走廊单侧墙右转

**环境**：走廊，左侧是墙，右侧开阔

**传感器读数**：
```
F = 0.80m  (前方可通)
L = 0.35m  (左侧墙壁)
R = 1.20m  (右侧开阔)
```

**决策过程**：
1. 检查：L=0.35 < 0.5 ✓
2. 检查：F=0.80 > 0.5 ✓
3. **识别**：➡️  左墙右通
4. **动作**：ROTATE_RIGHT

**结果**：✅ 右转进入开阔区域

**日志输出**：
```
🤖 LLM: ROTATING_RIGHT  | ➡️  左墙右通  | F=0.80 L=0.35 R=1.20
```

---

## 🔧 参数调优

### 如果门口仍然无法通过

**问题**：门口太窄（< 0.5m）

**解决**：放宽狭窄通道的前方阈值

```python
# llm_mapper.py 第 228 行
elif L < 0.8 and R < 0.8 and F > 0.5:
# 改为
elif L < 0.8 and R < 0.8 and F > 0.45:
```

---

### 如果在走廊误判为门口

**问题**：走廊宽度 < 1.6m，被误判为狭窄通道

**解决**：收紧狭窄通道的侧边阈值

```python
# llm_mapper.py 第 228 行
elif L < 0.8 and R < 0.8 and F > 0.5:
# 改为
elif L < 0.7 and R < 0.7 and F > 0.5:
```

---

### 如果转向不够灵敏

**问题**：在宽阔空间不转向探索

**解决**：调整场景 2/3 的侧边阈值

```python
# llm_mapper.py 第 218, 223 行
elif L < 0.5 and F > 0.5:
# 改为
elif L < 0.6 and F > 0.5:
```

---

## 📊 场景优先级

决策系统按以下顺序检查场景（优先级从高到低）：

| 优先级 | 场景 | 原因 |
|--------|------|------|
| 1 | ⚠️  死胡同 | 紧急情况，必须立即后退 |
| 2 | ➡️  左墙右通 | 明确的单侧障碍，应优先处理 |
| 3 | ⬅️  右墙左通 | 明确的单侧障碍，应优先处理 |
| 4 | 🚪 狭窄通道 | 门口特征，应该通过 |
| 5 | 🛣️  前方开阔 | 安全前进 |
| 6 | 🔄 需要转向 | 默认策略 |

**为什么这个顺序？**

1. **死胡同优先**：避免撞墙
2. **单侧墙优先**：明确的导航指引
3. **狭窄通道次之**：识别门口
4. **开阔前进次之**：常规导航
5. **转向最后**：兜底策略

---

## 💡 与旧系统对比

### 旧系统（基于开阔度）

```python
# 门口检测
is_doorway = (L > 1.5) and (R > 1.5) and (0.5 < F < 1.0)
```

**问题**：
- ❌ 要求两侧非常开阔（> 1.5m）
- ❌ 实际门口通常两侧是墙（< 1m）
- ❌ 漏检大量真实门口

---

### 新系统（基于狭窄度）

```python
# 狭窄通道检测
is_doorway = (L < 0.8) and (R < 0.8) and (F > 0.5)
```

**优点**：
- ✅ 识别两侧都近的特征
- ✅ 符合实际门口情况
- ✅ 准确率大幅提升

---

## 🎯 决策规则总结

### 核心逻辑

| 条件 | 场景 | 动作 | 理由 |
|------|------|------|------|
| F<0.5 && L<0.5 && R<0.5 | 死胡同 | BACKUP | 三面墙，必须退 |
| L<0.5 && F>0.5 | 左墙右通 | ROTATE_RIGHT | 向开阔处转 |
| R<0.5 && F>0.5 | 右墙左通 | ROTATE_LEFT | 向开阔处转 |
| **L<0.8 && R<0.8 && F>0.5** | **狭窄通道** | **FORWARD** | **门口！通过** |
| F>0.6 | 前方开阔 | FORWARD | 安全前进 |
| 其他 | 需转向 | ROTATE | 找开阔处 |

---

## 🧪 测试建议

### 测试场景清单

1. **标准门口**（0.8m 宽）
   - 预期：识别为 🚪 狭窄通道，前进

2. **窄门口**（0.6m 宽）
   - 预期：识别为 🚪 狭窄通道，前进

3. **宽走廊**（2.0m 宽）
   - 预期：识别为 🛣️ 前方开阔，前进

4. **T 型路口**
   - 预期：识别为 ⬅️/➡️，转向

5. **死胡同**
   - 预期：识别为 ⚠️ 死胡同，后退

---

## 📝 总结

### 核心改进

1. **从"开阔度"到"狭窄度"**
   - 旧：L>1.5 && R>1.5（开阔房间）
   - 新：L<0.8 && R<0.8（狭窄通道）

2. **三轴联合判断**
   - 不只看前方，综合左右信息
   - 识别更多场景类型

3. **明确的优先级**
   - 紧急情况优先（死胡同）
   - 明确指引次之（单侧墙）
   - 常规导航最后（开阔前进）

### 适用环境

- ✅ 办公室、实验室（标准门 0.8-1.0m）
- ✅ 住宅、公寓（房门 0.7-0.9m）
- ✅ 走廊、通道（1.2-2.0m）
- ✅ T 型/十字路口
- ✅ 死胡同、房间角落

---

**文档版本**：v1.0
**最后更新**：2025-12-30
**对应代码版本**：commit e1118ce
**状态**：✅ 生产可用
