# 地图保存与加载使用指南

## 🎯 功能概述

提供两个脚本用于保存和恢复建图进度：

1. **`保存地图和位置.sh`** - 保存当前地图和机器人位置
2. **`加载地图和位置.sh`** - 加载已保存的地图和机器人位置

---

## 📋 使用场景

### 场景 1：建图中断恢复
建图过程中需要暂停（关机、切换任务等），希望下次从当前位置继续。

### 场景 2：多次建图合并
在同一环境的不同区域分别建图，最终合并。

### 场景 3：测试与调试
保存建图良好的状态，用于测试导航算法或重现问题。

---

## 🚀 快速开始

### 基础用法

#### 保存地图
```bash
# 保存当前地图和机器人位置（自动生成时间戳命名）
bash 保存地图和位置.sh

# 保存到指定名称
bash 保存地图和位置.sh robot1 my_office_map

# 保存其他机器人的地图
bash 保存地图和位置.sh robot2
```

#### 加载地图
```bash
# 交互式选择地图
bash 加载地图和位置.sh

# 直接加载最新地图
bash 加载地图和位置.sh robot1 /workspaces/AURO2025/solution/saved_maps/map_20251230_143000

# 加载指定机器人命名空间
bash 加载地图和位置.sh robot2 /path/to/map
```

---

## 📂 文件结构

每次保存会生成以下文件：

```
solution/saved_maps/
├── map_20251230_143000.pgm          # 地图图像（灰度）
├── map_20251230_143000.yaml         # 地图配置（分辨率、原点）
├── map_20251230_143000_pose.yaml    # 机器人位置信息
├── map_20251230_143000_summary.txt  # 摘要信息
├── load_map_20251230_143000.sh      # 快速加载脚本
└── map_latest.pbstream              # 指向最新地图的符号链接（如果有）
```

---

## 📖 详细使用说明

### 保存脚本详解 (`保存地图和位置.sh`)

#### 参数说明
```bash
bash 保存地图和位置.sh [机器人命名空间] [地图名称]
```

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 机器人命名空间 | `robot1` | ROS2 命名空间（如 robot1, robot2） |
| 地图名称 | `map_YYYYMMDD_HHMMSS` | 地图文件名（不含扩展名） |

#### 执行流程

**步骤 1/3: 保存地图**
- 调用 `nav2_map_server` 的 `map_saver_cli`
- 订阅 `/{namespace}/map` 话题
- 生成 `.pgm` 和 `.yaml` 文件

**步骤 2/3: 获取机器人位置**
- 优先从 `/{namespace}/odom` 话题读取
- 如果失败，尝试从 TF (`map` → `{namespace}/base_footprint`) 读取
- 提取位置 (x, y, z) 和姿态四元数 (qx, qy, qz, qw)

**步骤 3/3: 保存位置信息**
- 创建 `_pose.yaml` 文件保存位置数据
- 生成快速加载脚本 `load_*.sh`
- 创建摘要文件 `_summary.txt`

#### 输出示例
```
🗺️  保存地图和机器人位置
================================

📋 配置信息：
  机器人命名空间: /robot1
  保存目录: /workspaces/AURO2025/solution/saved_maps
  地图名称: office_map

💾 步骤 1/3: 保存地图...
✅ 地图保存成功: /workspaces/AURO2025/solution/saved_maps/office_map.pgm/yaml

📍 步骤 2/3: 获取机器人位置...
✅ 机器人位置：
   位置: x=1.234, y=2.345, z=0.000
   姿态: qx=0.0, qy=0.0, qz=0.707, qw=0.707

💾 步骤 3/3: 保存位置信息...
✅ 位置信息保存成功: office_map_pose.yaml
✅ 创建快速加载脚本: load_office_map.sh

🎉 完成！地图和位置已保存
```

---

### 加载脚本详解 (`加载地图和位置.sh`)

#### 参数说明
```bash
bash 加载地图和位置.sh [机器人命名空间] [地图文件路径]
```

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 机器人命名空间 | `robot1` | ROS2 命名空间 |
| 地图文件路径 | 交互式选择 | 地图文件完整路径（不含扩展名） |

#### 执行流程

**步骤 1/2: 启动地图服务器**
- 检查并停止已存在的地图服务器
- 启动新的 `nav2_map_server` 节点
- 验证 `/{namespace}/map` 话题是否正常发布

**步骤 2/2: 设置机器人位置**
- 从 `_pose.yaml` 读取保存的位置信息
- 发布到 `/{namespace}/initialpose` 话题（用于 AMCL 初始化）
- 设置协方差矩阵（x, y, yaw 方向）

#### 交互式选择界面
```
🔄 加载地图和机器人位置
================================

📂 可用的地图：

   [1] office_map_20251230_143000
       时间: 2025-12-30 14:30:00
       文件: /workspaces/AURO2025/solution/saved_maps/office_map_20251230_143000.yaml

   [2] lab_map_20251229_163000
       时间: 2025-12-29 16:30:00
       文件: /workspaces/AURO2025/solution/saved_maps/lab_map_20251229_163000.yaml

请选择地图编号 [1-2] 或按 Enter 使用最新:
```

#### 输出示例
```
📋 加载配置：
  机器人命名空间: /robot1
  地图文件: /workspaces/AURO2025/solution/saved_maps/office_map.yaml

🗺️  步骤 1/2: 启动地图服务器...
✅ 地图服务器已启动 (PID: 12345)

📍 步骤 2/2: 设置机器人位置...
✅ 读取位置：
   位置: x=1.234, y=2.345, z=0.000
   姿态: qx=0.0, qy=0.0, z=0.707, qw=0.707

📡 发布初始位置到 /robot1/initialpose...
✅ 初始位置已发布

🎉 完成！
================================

📊 状态信息：
  地图服务器 PID: 12345
  地图话题: /robot1/map
  初始位置: 已发布到 /robot1/initialpose

🛑 停止地图服务器：
  kill 12345
```

---

## 🔧 高级用法

### 1. 自动生成的快速加载脚本

保存地图时会自动生成 `load_*.sh` 脚本，可直接执行：

```bash
bash /workspaces/AURO2025/solution/saved_maps/load_office_map.sh
```

### 2. 查看摘要信息

```bash
cat /workspaces/AURO2025/solution/saved_maps/office_map_summary.txt
```

输出示例：
```
地图保存摘要
=====================================

保存时间: 2025-12-30 14:30:00
机器人: robot1
地图名称: office_map

文件列表:
---------
1. 地图图像: office_map.pgm
2. 地图配置: office_map.yaml
3. 位置信息: office_map_pose.yaml
4. 加载脚本: load_office_map.sh
5. 摘要信息: office_map_summary.txt

机器人位置:
-----------
Position: x=1.234, y=2.345, z=0.000
Orientation: qx=0.0, qy=0.0, qz=0.707, qw=0.707

如何加载:
---------
方法 1 (快捷方式):
  bash /workspaces/AURO2025/solution/saved_maps/load_office_map.sh

方法 2 (手动):
  bash 加载地图和位置.sh robot1 /workspaces/AURO2025/solution/saved_maps/office_map
```

### 3. 与 AMCL 集成

如果使用 AMCL 进行定位：

```bash
# 终端 1: 启动 AMCL
ros2 launch nav2_bringup localization_launch.py \
  map:=/workspaces/AURO2025/solution/saved_maps/office_map.yaml \
  use_sim_time:=true \
  namespace:=robot1

# 终端 2: 加载地图和位置
bash 加载地图和位置.sh robot1 /workspaces/AURO2025/solution/saved_maps/office_map
```

### 4. 在 RViz 中可视化

```bash
# 启动 RViz
ros2 run rviz2 rviz2

# 在 RViz 中添加：
# - Add → By topic → /robot1/map → Map
# - Add → By topic → /robot1/initialpose → PoseWithCovarianceStamped
```

---

## ⚠️  注意事项

### 保存脚本注意事项

1. **ROS2 环境必须已 source**
   ```bash
   source install/setup.bash
   ```

2. **地图话题必须存在**
   - 确保 Cartographer 或其他 SLAM 节点正在运行
   - 检查话题：`ros2 topic list | grep map`

3. **机器人必须在运行**
   - odom 或 TF 话题必须发布
   - 否则无法获取位置信息

4. **保存目录权限**
   - 默认保存到 `solution/saved_maps/`
   - 确保有写入权限

### 加载脚本注意事项

1. **地图服务器冲突**
   - 脚本会自动停止已存在的地图服务器
   - 可能影响其他正在运行的节点

2. **AMCL 初始化**
   - `initialpose` 话题需要 AMCL 订阅才有效
   - 如果不使用 AMCL，可忽略位置设置

3. **命名空间一致性**
   - 保存和加载必须使用相同的命名空间
   - 否则话题无法匹配

4. **后台进程管理**
   - 地图服务器在后台运行
   - 记录 PID 以便手动停止

---

## 🐛 故障排查

### 问题 1：保存时提示 "未找到 ros2 命令"

**原因**：ROS2 环境未激活

**解决**：
```bash
source install/setup.bash
bash 保存地图和位置.sh
```

---

### 问题 2：保存时提示 "地图保存失败"

**原因**：地图话题不存在或无数据

**检查**：
```bash
# 检查地图话题
ros2 topic list | grep map

# 查看地图数据
ros2 topic echo /robot1/map nav_msgs/msg/OccupancyGrid --once
```

**解决**：确保 SLAM 节点（如 Cartographer）正在运行

---

### 问题 3：无法获取机器人位置

**症状**：
```
⚠️  警告：无法从 /robot1/odom 获取位置
   尝试从 TF 获取...
❌ 无法获取机器人位置
```

**原因**：odom 和 TF 都不可用

**检查**：
```bash
# 检查 odom 话题
ros2 topic echo /robot1/odom geometry_msgs/msg/Odometry --once

# 检查 TF
ros2 run tf2_ros tf2_echo map robot1/base_footprint
```

**解决**：确保机器人仿真或硬件正在运行

---

### 问题 4：加载时地图服务器启动失败

**症状**：
```
❌ 地图服务器启动失败
```

**原因**：地图文件不存在或格式错误

**检查**：
```bash
# 验证文件存在
ls -lh /workspaces/AURO2025/solution/saved_maps/office_map.*

# 检查 YAML 格式
cat /workspaces/AURO2025/solution/saved_maps/office_map.yaml
```

**解决**：确保 `.pgm` 和 `.yaml` 都存在且完整

---

### 问题 5：初始位置未生效

**症状**：加载后机器人位置未改变

**原因**：AMCL 未运行或未订阅 `initialpose`

**检查**：
```bash
# 检查 AMCL 节点
ros2 node list | grep amcl

# 检查 initialpose 订阅者
ros2 topic info /robot1/initialpose
```

**解决**：
- 如果使用 AMCL：确保 AMCL 已启动
- 如果不使用 AMCL：手动设置机器人位置（通过 Gazebo 或其他方式）

---

## 📊 与增量建图集成

如果使用 Cartographer 的 `.pbstream` 状态文件（增量建图功能），可以结合使用：

```bash
# 1. 保存 Cartographer 状态（通过 llm_mapping.launch.py）
ros2 launch solution llm_mapping.launch.py mapping_duration:=1800

# 2. 转换 .pbstream 到 .pgm/.yaml（如需要）
ros2 run cartographer_ros cartographer_pbstream_to_ros_map \
  -pbstream_filename=/workspaces/AURO2025/solution/maps/llm_map_state_latest.pbstream \
  -map_filestem=/workspaces/AURO2025/solution/saved_maps/converted_map

# 3. 保存机器人位置
bash 保存地图和位置.sh robot1 converted_map

# 4. 后续加载
bash 加载地图和位置.sh robot1 /workspaces/AURO2025/solution/saved_maps/converted_map
```

---

## 💡 最佳实践

### 1. 命名规范

使用描述性名称：
```bash
# ✅ 好的命名
bash 保存地图和位置.sh robot1 office_floor2_east
bash 保存地图和位置.sh robot1 lab_complete
bash 保存地图和位置.sh robot1 warehouse_zone_a

# ❌ 不好的命名
bash 保存地图和位置.sh robot1 map1
bash 保存地图和位置.sh robot1 test
```

### 2. 定期备份

建图过程中定期保存：
```bash
# 每 15 分钟保存一次
while true; do
  sleep 900
  bash 保存地图和位置.sh robot1 "auto_backup_$(date +%H%M)"
done
```

### 3. 版本管理

为重要地图创建版本：
```bash
bash 保存地图和位置.sh robot1 office_v1
bash 保存地图和位置.sh robot1 office_v2_with_furniture
bash 保存地图和位置.sh robot1 office_v3_final
```

### 4. 清理旧文件

定期清理过期地图：
```bash
# 保留最近 10 个地图
cd /workspaces/AURO2025/solution/saved_maps/
ls -t map_*.pgm | tail -n +11 | xargs -I {} rm -f {%.pgm}*
```

---

## 📚 相关文档

- [Cartographer 增量建图使用指南](./增量建图使用指南.md)
- [Nav2 地图服务器文档](https://navigation.ros.org/configuration/packages/configuring-map-server.html)
- [AMCL 定位配置](https://navigation.ros.org/configuration/packages/configuring-amcl.html)

---

**文档版本**：v1.0
**最后更新**：2025-12-30
**作者**：Claude Code
**状态**：✅ 生产可用
