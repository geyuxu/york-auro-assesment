# 正确的建图步骤 - AURO2025

**重要：** 不需要创建新的启动文件，直接使用 assessment 包提供的工具。

---

## 完整建图流程

### 步骤 1：启动仿真环境

**打开终端 1**，运行：

```bash
cd /workspaces/AURO2025
source install/setup.bash

ros2 launch assessment assessment.launch.py \
  num_robots:=1 \
  use_nav2:=false \
  use_rviz:=false \
  headless:=false \
  random_seed:=42
```

**说明：**
- `num_robots:=1` - 只用一个机器人建图
- `use_nav2:=false` - 不启动导航（建图阶段不需要）
- `use_rviz:=false` - 先不启动 RViz（下一步会单独启动）
- `headless:=false` - 显示 Gazebo 界面，可以看到机器人

---

### 步骤 2：启动 Cartographer SLAM + RViz

**打开终端 2**，运行：

```bash
cd /workspaces/AURO2025
source install/setup.bash

ros2 launch assessment cartographer.launch.py \
  ns:=robot1 \
  use_sim_time:=true \
  use_rviz:=true
```

**说明：**
- 这会启动 Cartographer SLAM 节点
- 同时启动 RViz 显示实时建图过程
- `ns:=robot1` 指定机器人命名空间

**RViz 中应该看到：**
- 机器人模型
- 激光雷达扫描点（红色）
- 正在构建的地图（网格）

---

### 步骤 3：手动遥控机器人

**打开终端 3**，运行：

```bash
cd /workspaces/AURO2025
source install/setup.bash

ros2 run turtlebot3_teleop teleop_keyboard \
  --ros-args --remap cmd_vel:=/robot1/cmd_vel
```

**操作键位：**
```
w - 前进
x - 后退
a - 左转
d - 右转
s - 停止
空格 - 紧急停止
```

**建图策略（重要！）：**

1. **慢速移动**
   - 每次按 `w` 只按一下，不要连续按
   - 转弯时慢慢转，避免急转

2. **系统性覆盖**
   ```
   建议路线：
   起点 → 沿外墙顺时针 → 覆盖中央 → 接近绿色区 → 接近蓝色区 → 回到起点
   ```

3. **确保完整性**
   - 所有墙壁都要靠近扫描
   - 绿色收集区（Collection Zone）要能看清
   - 蓝色去污区（Decontamination Zone）要能看清
   - 中央区域不要留空白

4. **形成闭环**
   - 最后回到起点附近
   - 这有助于 Cartographer 优化地图

5. **观察 RViz**
   - 地图应该连续，没有断裂
   - 墙壁应该是清晰的线条
   - 未探索区域会是灰色

---

### 步骤 4：保存地图

当地图看起来完整时，**打开终端 4**：

```bash
cd /workspaces/AURO2025
source install/setup.bash

# 确保目录存在
mkdir -p solution/config

# 保存地图（重要：需要重新映射话题到 /robot1/map）
ros2 run nav2_map_server map_saver_cli -f solution/config/map2 \
  --ros-args -r map:=/robot1/map
```

**检查保存结果：**

```bash
ls -lh solution/config/map2.*
```

应该看到：
```
-rw-r--r-- 1 ubuntu ubuntu  XXX  solution/config/map2.pgm
-rw-r--r-- 1 ubuntu ubuntu  XXX  solution/config/map2.yaml
```

**查看地图配置：**

```bash
cat solution/config/map2.yaml
```

应该类似：
```yaml
image: map2.pgm
mode: trinary
resolution: 0.05
origin: [-X.XX, -X.XX, 0.0]
negate: 0
occupied_thresh: 0.65
free_thresh: 0.25
```

---

### 步骤 5：停止建图

依次停止各个程序：

1. **终端 3**（遥控）：按 `Ctrl+C`
2. **终端 2**（Cartographer + RViz）：按 `Ctrl+C`
3. **终端 1**（仿真环境）：按 `Ctrl+C`

---

## 验证地图

### 方法 1：用图像查看器打开

```bash
# 在 VNC 桌面中
eog solution/config/map2.pgm
```

或者：

```bash
# 如果有 display
display solution/config/map2.pgm
```

### 方法 2：用 Nav2 测试

```bash
cd /workspaces/AURO2025
source install/setup.bash

ros2 launch solution solution_launch.py \
  num_robots:=1 \
  random_seed:=42 \
  use_nav2:=true \
  headless:=false \
  use_rviz:=true
```

**在 RViz 中检查：**
- 地图应该正确加载
- 机器人应该能定位（绿色粒子云收敛）
- 可以用 "2D Goal Pose" 工具测试导航

---

## 故障排查

### 问题：找不到 map_saver_cli

**解决：**
```bash
sudo apt update
sudo apt install ros-humble-nav2-map-server
```

### 问题：Cartographer 启动失败

**检查是否安装：**
```bash
ros2 pkg list | grep cartographer
```

**如果没有，安装：**
```bash
sudo apt update
sudo apt install ros-humble-turtlebot3-cartographer
```

### 问题：RViz 中看不到地图

**检查地图话题：**
```bash
ros2 topic list | grep map
```

应该看到：
```
/robot1/map
/robot1/map_metadata
```

**在 RViz 中：**
- Fixed Frame 应该是 `robot1/map`
- 添加 Map 显示
- Topic 设为 `/robot1/map`

### 问题：地图质量差（扭曲、不连续）

**原因：** 移动太快或转弯太急

**解决：**
1. 重新建图
2. 移动更慢
3. 确保平滑转弯
4. 多重叠路径

### 问题：保存地图后文件为空

**检查：**
```bash
# 确保在正确的工作目录
pwd
# 应该在 /workspaces/AURO2025

# 确保目录存在
mkdir -p solution/config

# 使用绝对路径保存（记得重新映射话题）
ros2 run nav2_map_server map_saver_cli \
  -f /workspaces/AURO2025/solution/config/map2 \
  --ros-args -r map:=/robot1/map
```

---

## 完整命令速查表

```bash
# ============ 终端 1 ============
cd /workspaces/AURO2025 && source install/setup.bash
ros2 launch assessment assessment.launch.py num_robots:=1 use_nav2:=false use_rviz:=false headless:=false random_seed:=42

# ============ 终端 2 ============
cd /workspaces/AURO2025 && source install/setup.bash
ros2 launch assessment cartographer.launch.py ns:=robot1 use_sim_time:=true use_rviz:=true

# ============ 终端 3 ============
cd /workspaces/AURO2025 && source install/setup.bash
ros2 run turtlebot3_teleop teleop_keyboard --ros-args --remap cmd_vel:=/robot1/cmd_vel

# ============ 终端 4 ============
cd /workspaces/AURO2025 && source install/setup.bash
mkdir -p solution/config
ros2 run nav2_map_server map_saver_cli -f solution/config/map2 --ros-args -r map:=/robot1/map
ls -lh solution/config/map2.*

# ============ 验证 ============
cd /workspaces/AURO2025 && source install/setup.bash
ros2 launch solution solution_launch.py num_robots:=1 random_seed:=42 use_nav2:=true headless:=false
```

---

## 下一步

地图创建完成后：

1. ✅ 测试自主导航系统
2. ✅ 运行不同的测试场景
3. ✅ 验证提交：`./rcutil.py check-submission`
4. ✅ 打包提交：`./rcutil.py zip-workspace`

---

**注意：** 建图是一次性任务。一旦有了好的地图，就可以在所有不同的 random_seed 场景中重复使用，因为环境结构是固定的，只有桶的位置是随机的。
