# LLM 建图参数说明

## 🎯 当前配置（v3 - 安全优先）

### 速度参数
| 参数 | 值 | 说明 |
|------|-----|------|
| `LINEAR_SPEED` | 0.08 m/s | 前进速度（降低以提高 SLAM 稳定性） |
| `ANGULAR_SPEED` | 0.25 rad/s | 旋转速度（降低以避免急转） |
| `BACKUP_SPEED` | -0.05 m/s | 后退速度 |

### 安全阈值
| 参数 | 值 | 说明 |
|------|-----|------|
| 前进阈值 | 0.6m | 前方至少 0.6m 才前进 |
| 后退阈值 | 0.4m | 前方小于 0.4m 时后退 |
| 旋转阈值 | 0.6m | 前方小于 0.6m 时旋转 |

### 时间参数
| 参数 | 值 | 说明 |
|------|-----|------|
| `total_mapping_time` | 7200 秒 | 总建图时长（2 小时） |
| `llm_decision_interval` | 5 秒 | LLM 决策间隔 |
| `state_timeout` | 5 秒 | 单个状态最长持续时间 |

---

## 📊 版本历史

### v3 - 安全优先（当前版本）
**日期**：2025-12-30
**目标**：防止撞墙，保护 SLAM 定位

**参数**：
- 前进速度：0.08 m/s
- 旋转速度：0.25 rad/s
- 前进阈值：0.6m
- 建图时长：2 小时

**优点**：
- ✅ 不会撞墙
- ✅ SLAM 稳定
- ✅ 地图质量高

**缺点**：
- ⚠️ 速度较慢
- ⚠️ 可能难以通过窄门（< 0.6m）

---

### v2 - 激进版本（已废弃）
**日期**：2025-12-30
**目标**：通过门口

**参数**：
- 前进速度：0.1 m/s
- 旋转速度：0.3 rad/s
- 前进阈值：0.5m
- 建图时长：2 小时

**问题**：
- ❌ 容易撞墙
- ❌ SLAM 定位失败
- ❌ 地图错乱

---

### v1 - 保守版本（已废弃）
**日期**：2025-12-30
**目标**：高安全性

**参数**：
- 前进速度：0.1 m/s
- 旋转速度：0.3 rad/s
- 前进阈值：0.8m
- 建图时长：1 小时

**问题**：
- ❌ 在门口打转
- ❌ 无法进入室内

---

## 🔧 参数调优指南

### 如果机器人撞墙
1. **提高安全阈值**：
   ```python
   # llm_mapper.py 第 216 行
   - FORWARD: if F>0.6m
   + FORWARD: if F>0.7m
   ```

2. **降低速度**：
   ```python
   # llm_mapper.py 第 50-51 行
   self.LINEAR_SPEED = 0.06  # 从 0.08 降低
   self.ANGULAR_SPEED = 0.2  # 从 0.25 降低
   ```

### 如果机器人无法通过门口
1. **降低安全阈值**：
   ```python
   # llm_mapper.py 第 216 行
   - FORWARD: if F>0.6m
   + FORWARD: if F>0.55m
   ```

2. **增加提示词强度**：
   ```python
   # llm_mapper.py 第 221-222 行
   CRITICAL: Never hit walls! SLAM breaks if you collide.
   Goal: Safe exploration, maintain 0.6m clearance. Choose ONE word:
   + Doorways are ~0.8m wide, safe to pass if F>0.55m.
   ```

### 如果建图速度太慢
1. **提高速度**（谨慎）：
   ```python
   # llm_mapper.py 第 50 行
   self.LINEAR_SPEED = 0.1  # 从 0.08 提高
   ```

2. **缩短决策间隔**：
   ```python
   # llm_mapper.py 第 72 行
   self.llm_decision_interval = 3.0  # 从 5.0 缩短
   ```

### 如果 SLAM 定位漂移
1. **进一步降低速度**：
   ```python
   self.LINEAR_SPEED = 0.05
   self.ANGULAR_SPEED = 0.2
   ```

2. **增加状态超时**：
   ```python
   # llm_mapper.py 第 335 行
   if state_duration > 10.0:  # 从 5.0 增加
   ```

---

## 🎮 手动微调流程

### 步骤 1：修改参数
编辑 `/workspaces/AURO2025/solution/solution/llm_mapper.py`

### 步骤 2：重新构建
```bash
cd /workspaces/AURO2025
colcon build --packages-select solution --symlink-install
```

### 步骤 3：测试
```bash
source install/setup.bash
ros2 run solution llm_mapper --ros-args --remap __ns:=/robot1
```

### 步骤 4：观察指标
- **撞墙次数**：应为 0
- **地图覆盖率**：30 分钟应达到 >50%
- **定位稳定性**：机器人位置应平滑移动，无跳变

---

## 📈 推荐配置矩阵

| 场景 | LINEAR_SPEED | 前进阈值 | 建图时长 | 适用情况 |
|------|--------------|----------|----------|----------|
| **快速测试** | 0.12 m/s | 0.7m | 30 分钟 | 验证系统是否工作 |
| **标准建图** | 0.08 m/s | 0.6m | 2 小时 | **当前配置，推荐** |
| **精细建图** | 0.05 m/s | 0.7m | 4 小时 | 高质量地图，复杂环境 |
| **激进模式** | 0.1 m/s | 0.5m | 1 小时 | 仅用于空旷环境 |

---

## 🐛 常见问题

### Q1：为什么降低速度？
**A**：Cartographer SLAM 需要稳定的传感器数据。速度过快会导致：
- 激光雷达扫描模糊
- 里程计累积误差
- 特征匹配失败
- 定位漂移

### Q2：0.6m 阈值会不会太大？
**A**：大多数门口宽度在 0.8-1.0m，0.6m 阈值可以安全通过。如果环境中有更窄的通道，可以降低到 0.55m。

### Q3：为什么建图需要 2 小时？
**A**：系统化覆盖整个环境需要时间。可以根据环境大小调整：
- 小房间（< 50㎡）：30-60 分钟
- 中型环境（50-100㎡）：1-2 小时
- 大型环境（> 100㎡）：2-4 小时

### Q4：LLM 决策会不会太慢？
**A**：5 秒间隔是平衡：
- 太快（< 3s）：API 成本高，可能超速率限制
- 太慢（> 10s）：决策滞后，效率低
- 5 秒：平衡成本和效率

---

## 💡 最佳实践

1. **先测试后部署**
   - 使用 30 分钟快速测试验证配置
   - 观察是否撞墙、卡住
   - 确认 SLAM 稳定后再长时间运行

2. **监控建图过程**
   - 在 RViz 中查看地图质量
   - 观察机器人是否重复访问同一区域
   - 检查定位是否漂移（机器人轨迹应该平滑）

3. **保存中间结果**
   - 每 30 分钟手动保存地图
   - 避免长时间运行后因错误丢失成果

4. **环境准备**
   - 确保 API Key 有效且有余额
   - 网络连接稳定
   - 足够的磁盘空间（地图文件 + 日志）

---

**文档版本**：v3
**最后更新**：2025-12-30
**维护者**：Claude Code
**状态**：✅ 生产可用
